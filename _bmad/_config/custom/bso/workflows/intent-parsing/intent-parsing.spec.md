# Workflow Specification: intent-parsing

**Module:** bso
**Status:** Validated -- Aligned with workflow.md
**Created:** 2026-02-07
**Updated:** 2026-02-07
**Workflow ID:** F3
**Agent:** orchestrator (inline logic, no separate agent)

---

## Workflow Overview

**Goal:** Parse natural language or structured user input into validated execution parameters with Story list resolution and user confirmation.

**Description:** Accepts free-form text (Chinese, English, or mixed), structured YAML/JSON, CLI flags, or interactive trigger. Extracts epic spec, story scope, filter, and execution options. Resolves concrete Story list from sprint-status.yaml. Presents parsed result with Story list detail for user confirmation before returning to Orchestrator main loop.

**Workflow Type:** Feature (F3)

---

## Steps

| Step | Name | Goal |
|------|------|------|
| 1 | Input Classification | Determine if input is Interactive Trigger / Precise Parameters / Natural Language |
| 2 | NL Parsing | Extract epic spec, filters, options from natural language via LLM inference |
| 3 | Parameter Mapping | Map extracted intent to structured parameters with default filling and validation |
| 4 | Story List Resolution | Resolve epic-spec + filter to concrete Story list from sprint-status.yaml |
| 5 | Confirmation Display | Show parsed params + Story list detail to user with confidence annotations |
| 6 | User Confirmation | Wait for user confirm / modify / reject (modify loop max 5 rounds) |
| 7 | Return | Return structured params to Orchestrator main loop |

---

## Workflow Inputs

### Required Inputs

- `raw_input`: Raw user input string (NL text, structured YAML/JSON, empty string, or `--interactive`)
- `sprint_status_path`: `sprint-status.yaml` file path (resolved via `status_file_search_paths` config)

### Optional Inputs

- `session_id`: Sprint session ID (generated by Orchestrator, e.g. `sprint-2026-02-07-001`)
- `config_overrides`: Runtime configuration overrides (object)

### Input Validation Rules

| Field | Validation | On Failure |
|-------|-----------|------------|
| `raw_input` | String type, empty allowed | Empty string --> classified as Interactive Trigger |
| `sprint_status_path` | File exists and is readable | abort, status: "failure", error: "sprint-status.yaml not found" |

---

## Workflow Outputs

### Return Value

```yaml
return:
  status: "confirmed" | "rejected" | "redirected" | "failure"
  epic_spec: "epic5"
  stories: ["5-1", "5-2", "5-3", "5-4", "5-5"]
  filter: "incomplete"
  options:
    review_strictness: "low"
    skip_story_review: false
    e2e: false
    parallel: 1
    dry_run: false
    no_research: false
    pre_research: false
    max_review_rounds: 10
    max_story_review_rounds: 3
  story_details:
    - key: "5-1"
      name: "Story Name"
      current_state: "backlog"
  parse_source: "nl" | "precise" | "interactive"
  errors: []
```

### Return Status Definitions

| Status | Meaning | Orchestrator Action |
|--------|---------|---------------------|
| `confirmed` | User confirmed execution | Enter Story queue scheduling main loop |
| `rejected` | User rejected execution | Terminate Sprint, output cancellation |
| `redirected` | Redirect to F4 interactive-guide | Launch F4 workflow |
| `failure` | Parse failed (unclassifiable input, NL parse failure, validation error, Epic not found, etc.) | Terminate Sprint, output error details |

---

## State Preconditions

N/A -- F3 is the entry-point parsing phase. No sprint-status.yaml state preconditions are required; the workflow reads state but does not require a specific Story state to begin.

## State Transitions

N/A -- F3 does not trigger any sprint-status.yaml state transitions. After F3 completes, the Orchestrator decides next steps based on the `status` return field.

---

## Agent Integration

### Primary Agent

Orchestrator (`bso-orchestrator`) -- inline logic, no separate agent. All steps execute within the Orchestrator process without external agent dispatch.

### Supporting Agents

None. This workflow is fully self-contained.

---

## Error Handling

| Error Condition | Detection Point | Severity | Behavior | Return Status |
|----------------|----------------|----------|----------|---------------|
| sprint-status.yaml not found | Step 4 | Fatal | Abort, prompt user to check status_file_search_paths config | `failure` |
| NL parse cannot identify epic_spec | Step 2 | Error | Return parse failure with input suggestions and examples | `failure` |
| epic_spec not found in sprint-status.yaml | Step 4 | Error | Abort, list available Epics for user selection | `failure` |
| Filtered Story list is empty | Step 4 | Warning | Continue to Step 5, explain reason, user can modify filter | N/A (continue) |
| YAML/JSON precise parameter format error | Step 3 | Error | Return parse error, prompt correct format | `failure` |
| Parameter value out of domain (e.g. review_strictness: "ultra") | Step 3 | Error | Return validation error, list valid values | `failure` |
| User modify loop exceeds 5 rounds | Step 6 | Warning | Terminate modify loop, prompt user to use precise params | `rejected` |
| Invalid Story Key format (e.g. "abc") | Step 3/4 | Error | Return format error, prompt correct format `N-M` | `failure` |
| Specified Story Key not in sprint-status.yaml | Step 4 | Warning | Filter out missing keys, warn user and continue | N/A (continue) |
| NL parse produces contradictory param combination | Step 2 | Info | Highlight in confirmation display, no auto-correction | N/A (continue) |
| sprint-status.yaml format corrupted (YAML unparseable) | Step 4 | Fatal | Abort, prompt user to check file format integrity | `failure` |
| parallel value exceeds filtered Story count | Step 4 | Info | Auto-adjust parallel to Story count, log adjustment | N/A (continue) |

---

## Configuration Dependencies

| Config Key | Location | Default | Used In |
|-----------|----------|---------|---------|
| `defaults.parallel` | `config.yaml` | 1 | Step 3 |
| `defaults.review_strictness` | `config.yaml` | `"medium"` | Step 3 |
| `defaults.max_review_rounds` | `config.yaml` | 10 | Step 3 |
| `defaults.max_story_review_rounds` | `config.yaml` | 3 | Step 3 |
| `e2e_inspection.enabled` | `config.yaml` | `false` | Step 3 |
| `status_file_search_paths` | `config.yaml` | (project-dependent) | Step 4 |
| `knowledge_research.enabled` | `config.yaml` | `true` | Step 3 |

---

## Design Principles Applied

| # | Principle | Application |
|---|-----------|-------------|
| 2 | Degrade over error | Step 2 (NL low-confidence --> annotate [inferred] instead of aborting); Step 4 (missing Story keys --> filter and warn) |
| 3 | Budget controls everything | Step 6 (user modify loop max 5 rounds) |
| 4 | Single entry point for state writes | Step 4 (read-only access to sprint-status.yaml, no writes) |
| 5 | State is the single source of truth | Step 4 (Story state solely from sprint-status.yaml, no assumptions or caching) |
| 7 | Always keep an escape hatch | Step 6 (user can reject anytime; modify loop with friendly exit on limit) |
| 9 | NL parsing capability | Step 2 (full NL engine, Chinese/English/mixed, multi-dimension intent extraction, confidence assessment, 12 examples) |
| 10 | Confirmation mechanism | Step 5-6 (complete display of params + Story list; support confirm/modify/reject; re-confirm after modification) |
| 17 | Execution visibility | Step 5 (comprehensive display: param list, Story queue table, skip reasons, confidence annotations) |

---

_Spec validated on 2026-02-07 against workflow.md implementation via bmad:bmb:workflows:workflow validate mode (YOLO)_
_Source: intent-parsing.spec.md (original) + workflow.md (validated implementation)_
