# BSO Sprint Orchestrator — Configuration
# User-customizable settings for autonomous sprint execution
# Version: 1.0.0

# Role mapping — which BMAD agent persona for each phase
role_mapping:
  story_creator_persona: "bmad:bmm:agents:sm"
  story_reviewer_persona: "bmad:bmm:agents:pm"
  dev_runner_persona: "bmad:bmm:agents:dev"
  review_runner_persona: "bmad:bmm:agents:architect"  # Different from dev_runner for review independence (Principle 30)
  e2e_inspector_persona: "bmad:bmm:agents:dev"
  knowledge_researcher_persona: "bmad:bmm:agents:architect"

# Workflow mapping — which BMAD workflow for each phase
workflow_mapping:
  create_story: "bmad:bmm:workflows:create-story"
  dev_story: "bmad:bmm:workflows:dev-story"
  code_review: "bmad:bmm:workflows:code-review"

# Default parameters (overridable via CLI)
defaults:
  parallel: 1
  max_review_rounds: 10
  max_story_review_rounds: 3
  review_strictness: "normal"    # strict / normal / lenient（用户面语义：strict=全修, lenient=只修HIGH）
  auto_clear_git_track: true
  story_review_enabled: true
  story_review_fallback: "ask_user"  # ask_user | force_pass | skip_story
  first_story_checkpoint: "pause"    # pause | report | skip
  yolo: false                      # YOLO full-auto mode (silences all user interaction points)

  # Agent timeout recovery (Principle 15)
  agent_timeout_seconds:
    story_creation: 900              # 15 min
    story_review: 900                # 15 min
    dev_execution: 1800              # 30 min (largest scope, TDD full cycle)
    code_review: 900                 # 15 min
    e2e_inspection: 900              # 15 min
    knowledge_research: 600          # 10 min (per call, includes network latency)
  agent_timeout_action: "mark_needs_intervention"  # mark_needs_intervention | retry_once | skip

  # Review progressive degradation (Principle 22)
  review_degradation:
    round_3: "lower_strictness"
    round_5: "high_only"
    round_8: "force_needs_intervention"

  # Token budget awareness (Principle 26)
  token_budget:
    enabled: true
    warning_threshold: 0.7
    action: "pause_and_report"       # pause_and_report | warn_and_continue | ignore

  # Story dependency detection (Principle 29)
  dependency_detection:
    mode: "file_overlap"             # file_overlap | none
    consecutive_failure_threshold: 3

# Knowledge research
knowledge_research:
  enabled: true
  knowledge_base_path: "{output_folder}/knowledge-base"
  # 路径解析说明:
  #   {output_folder} 来自 BMAD config.yaml 的 output_folder 字段（默认: {project-root}/_bmad-output）
  #   lessons 文件完整路径: {project_root}/_bmad-output/knowledge-base/lessons/_lessons-learned.md
  #   如果变量解析失败，Orchestrator 应使用硬编码相对路径: _bmad-output/knowledge-base/lessons/_lessons-learned.md
  cache_ttl_days: 30
  max_calls_per_story: 3
  timeout_seconds: 600
  cache_fuzzy_match: true
  sources:
    - context7
    - deepwiki
    - web_search
  fallback_if_mcp_unavailable: web_search

# E2E inspection (optional)
e2e_inspection:
  enabled: false
  mode: "interactive"                # interactive | semi-auto | full-auto
  environment:
    base_url: "http://localhost:3100"
    login:
      enabled: true
      url: "/login"
      default_username: "admin"
      default_password: ""
    wait_after_navigation: 2000
  browser_tool:
    preferred: "chrome_mcp"
    fallback: "playwright_mcp"
  trigger_conditions:
    - story_tags_include: ["frontend", "ui", "web", "page"]

# Git commit templates
git_commit_patterns:
  story_created: "docs: Story {epic}.{story}: {title} 创建开发文档"
  story_revised: "docs: Story {epic}.{story}: {title} 修订开发文档"
  dev_complete: "feat: Story {epic}.{story}: {title}"
  review_complete: "docs: Story {epic}.{story}: code review [round {round}]"
  fix_complete: "fix: Story {epic}.{story}: [review {round}] {description}"

# Git squash strategy (Principle 28)
git_squash_strategy: "per_story"     # per_story | per_phase | none

# Status file search paths
status_file_search_paths:
  - "{output_folder}/implementation-artifacts/sprint-status.yaml"
  - "./sprint-status.yaml"

# Agent Team Mode Configuration
# 使用 Claude Code Agent Team 架构，KR 常驻 + P2P 研究通信
team_mode:
  team_name_prefix: "bso-sprint"          # Team 名称前缀，完整名: {prefix}-{session_id}
  kr_startup_timeout: 30                  # KR 常驻队友创建后等待就绪超时(秒)
  agent_shutdown_timeout: 15              # 向 Agent 发送 shutdown_request 后等待响应超时(秒)
  research_message_timeout: 300           # Agent 发送研究请求后等待 KR 回复超时(秒)

  # Result delivery mode — Agent 完成后如何传递结果给主控
  result_delivery_mode: "sendmessage"     # sendmessage | tasklist
  # sendmessage: Agent 通过 SendMessage(AGENT_COMPLETE) 回报主控，主控等待消息自动递送
  # tasklist:    Agent 通过 TaskUpdate(completed) + metadata 写入结果，主控通过 TaskList 监控

  # Message protocol prefixes — Agent 和 KR 之间的消息格式约定
  message_protocol:
    agent_complete: "AGENT_COMPLETE"       # 临时 Agent → 主控: 任务完成报告
    research_request: "RESEARCH_REQUEST"   # 任意 Agent → KR: 研究请求
    research_result: "RESEARCH_RESULT"     # KR → 请求者: 研究结果

# ============================================================
# Resident Agent Slots — resident Agent pluggable configuration
# Supports source_type: bso_agent | bmad_skill | custom
# ============================================================
resident_slots:
  sm:
    enabled: true
    source_type: "bmad_skill"
    agent_ref: "bmad:core:agents:bmad-master"
    extends:
      workflows:
        - "bmad:bmm:workflows:correct-course"
    team_member_name: "scrum-master"
    subagent_type: "bso-scrum-master"
    startup_timeout: 30
    shutdown_timeout: 15
    description: "Sprint planning, batch grouping, course correction (CC)"

  kr:
    enabled: true
    source_type: "bso_agent"
    agent_ref: "bso:agents:knowledge-researcher"
    team_member_name: "knowledge-researcher"
    subagent_type: "bso-knowledge-researcher"
    startup_timeout: 30
    shutdown_timeout: 15
    description: "Technical research and knowledge cache"

  debugger:
    enabled: true
    source_type: "bso_agent"
    agent_ref: "bso:agents:debugger"
    team_member_name: "debugger"
    subagent_type: "bso-debugger"
    startup_timeout: 30
    shutdown_timeout: 15
    description: "Bug analysis, logging, fix routing"
    config:
      journal_path: ".sprint-session/debug-journal.md"
      on_context_full: "rebuild_with_journal"

  e2e_live:
    enabled: false
    source_type: "bso_agent"
    agent_ref: "bso:agents:e2e-live"
    team_member_name: "e2e-live"
    subagent_type: "bso-e2e-live"
    startup_timeout: 45
    shutdown_timeout: 15
    description: "Real-time browser operation assistant"
    requires:
      browser_mcp: "chrome_mcp | playwright_mcp"

  # User custom slot example
  # custom_agent:
  #   enabled: false
  #   source_type: "custom"
  #   agent_ref: ".claude/agents/my-agent.md"
  #   team_member_name: "my-agent"
  #   subagent_type: "my-agent"
  #   startup_timeout: 30
  #   shutdown_timeout: 15

# ============================================================
# Slave Configuration — Slave batch orchestration config
# ============================================================
slave_config:
  batch_size: 3
  max_concurrent_slaves: 1
  subagent_type: "bso-sprint-slave"
  auto_destroy_on_complete: true
  slave_timeout_seconds: 5400

# ============================================================
# Startup Interaction — Master startup interaction enhancement
# ============================================================
startup_interaction:
  status_file_confirm: true
  default_status_path: "{output_folder}/implementation-artifacts/sprint-status.yaml"
  show_resident_slots: true
  show_batch_plan_preview: true
